<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matecumbe Key Property Portal - Real-Time Sync (Firestore)</title>
    
    <style>
        /* Base Colors & Typography (Using standard Tailwind-like classes) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            min-height: 100vh;
            padding: 1rem; /* p-4 */
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* Responsive Padding for Header */
        @media (min-width: 768px) {
            body {
                padding: 2rem; /* md:p-8 */
            }
        }

        /* Utility Classes */
        .mx-auto { margin-left: auto; margin-right: auto; }
        .max-w-7xl { max-width: 80rem; }
        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 2.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-4 { padding: 1rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-mono { font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        /* Header Styling */
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .font-extrabold { font-weight: 800; }
        .text-indigo-700 { color: #4338ca; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-600 { color: #4b5563; }
        
        /* Main Content Layout (Desktop/Mobile) */
        #main-content-layout {
            display: flex;
            flex-direction: column; 
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        #map-section, #info-section {
            width: 100%; 
        }

        @media (min-width: 1024px) { 
            #main-content-layout {
                flex-direction: row; 
            }

            #map-section {
                width: 66.666667%; 
            }
            
            #info-section {
                width: 33.333333%; 
            }
            #info-panel {
                position: sticky;
                top: 1rem;
            }
        }
        
        /* Information Panel Styling */
        #info-panel {
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); 
            border-top: 4px solid #6366f1; 
        }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: #1f2937; }
        .text-indigo-600 { color: #4f46e5; }
        .italic { font-style: italic; }
        .text-gray-500 { color: #6b7280; }
        
        /* Unit Map Container Grid */
        .unit-map-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .unit-map-container {
                grid-template-columns: 1fr 1fr; 
            }
        }

        /* Individual Building Styling */
        .building-card h2 {
            font-size: 1.25rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            text-align: center;
            color: #4f46e5; 
            padding: 0.5rem; 
            background-color: #e0e7ff; 
        }
        
        /* Building Grid (4 columns inside each building) */
        .building-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 4px;
            padding: 16px;
            border: 2px solid #6366f1; 
            border-radius: 12px;
            background-color: #eef2ff; 
        }

        .unit {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px; 
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937; 
            background-color: #f7f8ff; 
            border: 1px solid #d1d5db; 
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none; 
            opacity: 0.8; 
        }

        .unit:hover:not(.inactive) {
            background-color: #fcd34d; 
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .unit.active {
            box-shadow: 0 0 0 4px #818cf8, 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Highlighted active state */
            transform: scale(1.02);
            opacity: 1;
        }

        .unit.inactive {
            background-color: #e5e7eb; 
            color: #9ca3af; 
            cursor: default;
            opacity: 0.6;
        }
        
        .unit.inactive.bg-gray-100 { 
            background-color: #f3f4f6; 
            border-style: dashed;
        }

        /* Market Status Colors */
        .unit.for-sale {
            background-color: #f97316; /* Orange */
            color: #fff;
            border-color: #ea580c; 
            opacity: 1;
        }

        .unit.rental {
            background-color: #3b82f6; /* Blue */
            color: #fff;
            border-color: #2563eb; 
            opacity: 1;
        }
        
        /* Both Active (Red) - Highest precedence */
        .unit.for-sale.rental {
            background-color: #ef4444; /* Red */
            color: #fff;
            border-color: #dc2626; 
            opacity: 1;
        }
        
        /* Styling for the checkbox section */
        .market-status-controls {
            display: none; 
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #d1d5db; 
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        .checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        .checkbox-group label {
            cursor: pointer;
        }
        
        /* Tailwind-based colors for checkbox labels */
        .text-orange-600 { color: #f97316; }
        .text-blue-600 { color: #3b82f6; }
        .text-red-600 { color: #ef4444; }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">Matecumbe Key Unit Map</h1>
            <p class="text-lg text-gray-600 mt-2">Real-time collaboration: Click a unit to set its shared market status.</p>
        </header>

        <!-- Status Message -->
        <div id="status-message" class="text-center text-sm mb-4 p-2 rounded-lg bg-blue-100 text-blue-800">
            Connecting to shared database...
        </div>

        <!-- Main Content Area -->
        <div id="main-content-layout">
            
            <!-- Unit Map Section -->
            <div id="map-section">
                <div class="unit-map-container">
                    <!-- Building 3170 -->
                    <div id="building-3170-map" class="building-card">
                        <h2>Building 3170 (Matecumbe Key Rd)</h2>
                        <div class="building-grid" id="grid-3170">
                            <!-- Units will be inserted here by JavaScript -->
                        </div>
                        <p class="text-sm text-center text-gray-500 mt-2">Units 111-138 (Schematic View)</p>
                    </div>

                    <!-- Building 3160 -->
                    <div id="building-3160-map" class="building-card">
                        <h2>Building 3160 (Matecumbe Key Rd)</h2>
                        <div class="building-grid" id="grid-3160">
                             <!-- Units will be inserted here by JavaScript -->
                        </div>
                        <p class="text-sm text-center text-gray-500 mt-2">Units 211-238 (Schematic View)</p>
                    </div>
                </div>
            </div>

            <!-- Information Panel Section -->
            <div id="info-section">
                <div id="info-panel" class="p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800" id="info-title">Select a Unit</h2>
                    <div id="info-content" class="text-gray-700">
                        <p>Click on any unit in the map to the left to display the owner's details here.</p>
                        
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-semibold text-indigo-600">Owner Name:</h3>
                            <p id="owner-name" class="italic text-gray-500" style="word-break: break-word;">Awaiting selection...</p>
                            
                            <h3 class="font-semibold text-indigo-600 mt-3">Mailing Address:</h3>
                            <p id="mailing-address" class="italic text-gray-500" style="word-break: break-word;">Awaiting selection...</p>
                        </div>
                        
                        <!-- Market Status Controls -->
                        <div id="market-status-section" class="market-status-controls">
                            <!-- Checkboxes will be injected here -->
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // setLogLevel is imported from the firestore module, not auth.
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Failed to parse Firebase config:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE REFERENCES ---
        let db;
        let auth;
        let userId = null; 
        const STATUS_DOC_ID = 'market-statuses';
        const STATUS_COLLECTION_PATH = `/artifacts/${appId}/public/data/unit_statuses`;
        
        // --- APPLICATION STATE ---
        const RAW_DATA = `3170 MATECUMBE KEY RD 111, Punta Gorda FL 33955 WYNNIK DARREN T + WYNNIK HEATHER Z — 3553 Potato Garden Run Rd, Imperial PA 15126
3170 MATECUMBE KEY RD 112, Punta Gorda FL 33955 FUNK SHEILA TR (For Sheila Funk Trust) — 473 Edgewater Dr, Morris IL 60450
3170 MATECUMBE KEY RD 113, Punta Gorda FL 33955 ENGKJER WANE S TR (For Waterfront Trust) — 51628 Pelican Point Dr, Detroit Lakes MN 56501
3170 MATECUMBE KEY RD 114, Punta Gorda FL 33955 2ND BILL RENTALS LLC — 17917 Courtside Landings Cir,, Punta Gorda FL 33955
3170 MATECUMBE KEY RD 115, Punta Gorda FL 33955 ORSINI WENDY L — P.O. Box 242, Pellston MI 49769
3170 MATECUMBE KEY RD 116, Punta Gorda FL 33955 HUFFMAN W ALAN + KATHRYN R TR (For W Alan Huffman Trust) — 4080 Cape Cole Blvd,, Punta Gorda FL 33955
3170 MATECUMBE KEY RD 117, Punta Gorda FL 33955 TENNYSON CHRISTOPHER + LISA — 69 Pine Valley Ct, Rotonda West FL 33947
3170 MATECUMBE KEY RD 118, Punta Gorda FL 33955 GREEN PETER + CLINTON RITA — 3870 Ontario Dr, North Tonawanda NY 14120
3170 MATECUMBE KEY RD 121, Punta Gorda FL 33955 HOLBEIN MARK ALLEN — 103 McIntyre Ln, Freeport PA 16229
3170 MATECUMBE KEY RD 122, Punta Gorda FL 33955 MANJ LLC — P.O. Box 682, Park Ridge IL 60068
3170 MATECUMBE KEY RD 123, Punta GORDA FL 33955 HOLBEIN MARK ALLEN 103 MCNTY RE LN FREEPORT PA 16229
3170 MATECUMBE KEY RD 124, Punta GORDA FL 33955 LONERGAN MARK S 1812 NE 44TH ST CAPE CORAL FL 33909
3170 MATECUMBE KEY RD 125, Punta GORDA FL 33955 SIMPSON JUDY 2545 DIANE AVE NORTH HUNTINGDON PA 15642
3170 MATECUMBE KEY RD 126, Punta GORDA FL 33955 LEVENDOFSKY LISA J 1321 VIA TOSCANA WAY SUN CITY CENTER FL 33573
3170 MATECUMBE KEY RD 127, Punta GORDA FL 33955 PERRAUD ROBERT C & PERRAUD CYNTHIA M PERRAUD TRUST 1910 E COCKATOO LN MELBOURNE BEACH FL 32951
3170 MATECUMBE KEY RD 128, Punta GORDA FL 33955 PETTY ROBERT R & JUDITH N 2511 CARDINAL HARBOUR RD PROSPECT KY 40059
3170 MATECUMBE KEY RD 131, Punta GORDA FL 33955 JENNINGS STEVEN + GROTHE DARLA — 3170 MATECUMBE KEY RD 131, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 132, Punta GORDA FL 33955 ANDERSON MICHAEL P & ZIEGENHORN CATHERINE 7455 BOCA VISTA ROAD, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 133, Punta GORDA FL 33955 SHANNON GERALD T TR FOR SHANNON TRUST PO BOX 775 WAKEFIELD ME 04086
3170 MATECUMBE KEY RD 134, Punta GORDA FL 33955 LIBBY ROBERT W & CYNTHIA F 463 OLD MEETINGHOUSE RD PORTER ME 04068
3170 MATECUMBE KEY RD 135, Punta GORDA FL 33955 FOLIO ANTHONY J 3170 MATECUMBE KEY RD #135, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 137, Punta GORDA FL 33955 LINDAHL JULIE 3170 MATECUMBE KEY RD #137, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 138, Punta GORDA FL 33955 CALL WILLIAM H JR & CALL BOBBI JD 3 STEVEN LN STEEP FALLS ME 04085
3160 MATECUMBE KEY RD 235 PUNTA GORDA FL 33955 KLADE BEATRICE 27W070 80TH ST NAPERVILLE IL 60565
3160 MATECUMBE KEY RD 236 PUNTA GORDA FL 33955 FLAHERTY JEFFREY SCOTT 905 CROSSING DR COVINGTON KY 41017
3160 MATECUMBE KEY RD 237 PUNTA GORDA FL 33955 AMMONS MAURICE ALLEN III + AMMONS DEBRA ENGLERT 1613 ST THOMAS DR MIDLOTHIAN VA 23114
3160 MATECUMBE KEY RD 238 PUNTA GORDA FL 33955 BASHAM DAVID W L/E 4581 N PASEO DE LOS CERRITOS TUCSON AZ 85745
3160 MATECUMBE KEY RD 223 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 224 PUNTA GORDA FL 33955 LEGER GERALD F & AMY L 25 ERIE LN GROTON CT 06340
3160 MATECUMBE KEY RD 225 PUNTA GORDA FL 33955 MARSHALL LARRY 3160 MATECUMBE KEY RD #225 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 226 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 227 PUNTA GORDA FL 33955 STEFANSKI PETER 3605 S MAYFIELD RD JACKSON WI 53037
3160 MATECUMBE KEY RD 228 PUNTA GORDA FL 33955 BADILLO LUIS & SANDRA 3160 MATECUMBE KEY RD #228 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 231 PUNTA GORDA FL 33955 HARWOOD GERALD W & HARWOOD JACQUELYN H 5198 ARROWWOOD DR PARK CITY UT 84098
3160 MATECUMBE KEY RD 232 PUNTA GORDA FL 33955 TRAVER-MUZIO SHARRON E + OBRIEN PHILLIP E L/E 24707 CEDAR RIDGE LANDINGS CIR PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 233 PUNTA GORDA FL 33955 MCDONAGH BARBARA A 5 ROCKY HOOK WALDEN MA 01880
3160 MATECUMBE KEY RD 234 PUNTA GORDA FL 33955 VECCHIARELLI ANGELO A + CARMONA BRENDA J 191 FLOWERING RIDGE RD WHITTIER NC 28789
3160 MATECUMBE KEY RD 211 PUNTA GORDA FL 33955 SANDERS KENNETH H III & SANDERS ROBERTA F + CLARK J A III ET AL 4919 GABRIEL LN WAUCHULA FL 33873
3160 MATECUMBE KEY RD 212 PUNTA GORDA FL 33955 SCOTT JOSEPH & TERRI LYNN 7996 AQUA ISLE CLAY MI 48001
3160 MATECUMBE KEY RD 213 PUNTA GORDA FL 33955 ANTHONSEN GARY 3797 PLUECKHAHN LANDINGS CIR PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 214 PUNTA GORDA FL 33955 LALONE DEREK J & NANETTE M 7779 COLONY DR CLAY MI 48001
3160 MATECUMBE KEY RD 215 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 216 PUNTA GORDA FL 33955 WHELAN WILLIAM W & WHELAN BARBARA W TR TRUST 3245 SUGARLOAF KEY RD #216 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 217 PUNTA GORDA FL 33955 WEGENER JAMES W & BEVERLY S 9624 DUNES DR FORT PIERCE SD 57532
3160 MATECUMBE KEY RD 218 PUNTA GORDA FL 33955 TANNOUS BETH ANN 3160 MATECUMBE KEY RD #218 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 221 PUNTA GORDA FL 33955 JOE S AUTOWHOLESALE INC 5708 RALEIGH DR NORFOLK VA 23502
3160 MATECUMBE KEY RD 222 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 27W070 80TH ST NAPERVILLE IL 60565`;


        let unitInfoData = {}; 
        let allUnitStatuses = {}; // Global state for market statuses from Firestore
        let activeUnitId = null; // Store the ID of the currently selected unit

        // --- FIREBASE FUNCTIONS ---

        /**
         * Initializes Firebase App, Auth, and Firestore.
         */
        async function initializeFirebase() {
            setLogLevel('Debug');
            const statusMessageElement = document.getElementById('status-message');
            
            if (Object.keys(firebaseConfig).length === 0) {
                statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-red-100 text-red-800';
                statusMessageElement.innerHTML = `<strong>CRITICAL ERROR:</strong> Firebase config missing. Real-time sync is impossible.`;
                console.error("Firebase Initialization Failed: Config is empty.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Wait for auth state to stabilize
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-green-100 text-green-800';
                            statusMessageElement.innerHTML = `<strong>Connected!</strong> User ID: <span class="font-mono text-xs">${userId}</span>. Changes are shared in real-time.`;
                            resolve();
                            unsubscribe();
                        } else {
                            // Should not happen if signIn* is successful, but good practice
                            userId = crypto.randomUUID();
                            console.warn("Signed in but no user ID immediately available. Using fallback UUID.");
                            resolve();
                            unsubscribe();
                        }
                    });
                });

                // 3. Start real-time listener for unit statuses
                startStatusListener();

            } catch (error) {
                statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-red-100 text-red-800';
                statusMessageElement.innerHTML = `<strong>CONNECTION FAILED:</strong> Check console for details. Data will not sync.`;
                console.error("Firebase Connection Error:", error);
            }
        }

        /**
         * Sets up the real-time listener for the public unit status document.
         */
        function startStatusListener() {
            if (!db) return;
            
            const statusDocRef = doc(db, STATUS_COLLECTION_PATH, STATUS_DOC_ID);

            onSnapshot(statusDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Update global state with the latest data
                    const firestoreData = docSnapshot.data();
                    // Firestore stores fields directly (unitId: {forSale: true, rental: false})
                    allUnitStatuses = firestoreData;
                    console.log("Real-time data received:", allUnitStatuses);
                } else {
                    // Initialize the document if it doesn't exist
                    console.log("Status document not found. Initializing...");
                    allUnitStatuses = {};
                    // We don't save immediately, we wait for the first user action.
                }

                // Redraw all map colors based on new data
                updateAllUnitColors();
                
                // If a unit is active, refresh the info panel to update checkbox states
                if (activeUnitId) {
                    updateInfoPanel(activeUnitId);
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
            });
        }

        /**
         * Saves the complete market status map back to Firestore.
         * We update the entire document atomically.
         * @param {Object} statuses The complete status map to save.
         */
        async function saveStatusesToFirestore(unitId, newStatus) {
            if (!db) {
                console.error("Firestore is not initialized. Cannot save.");
                return;
            }
            
            // 1. Update the local cache (which will be sent to Firestore)
            allUnitStatuses[unitId] = { 
                forSale: !!newStatus.forSale, 
                rental: !!newStatus.rental 
            };
            
            const statusDocRef = doc(db, STATUS_COLLECTION_PATH, STATUS_DOC_ID);
            
            try {
                // Use setDoc to overwrite the entire document with the current state (unitId is the field key)
                await setDoc(statusDocRef, allUnitStatuses, { merge: false });
                console.log(`Unit ${unitId} status saved successfully.`);
                // Note: The map will be updated via the onSnapshot listener, ensuring real-time consistency.
            } catch (e) {
                console.error("Error saving status to Firestore:", e);
            }
        }

        // --- UI and Data Logic ---

        /**
         * Parses the raw text data into a structured JavaScript object.
         */
        function parseData() {
            const lines = RAW_DATA.trim().split('\n');
            const dataMap = {};
            
            lines.forEach(line => {
                const propertyAddressMatch = line.match(/(31\d{2}) MATECUMBE KEY RD\s*(\d{3}),?\s*Punta Gorda FL\s*(\d{5})/i);

                if (propertyAddressMatch) {
                    const fullPropertyAddress = propertyAddressMatch[0]; 
                    const unitId = propertyAddressMatch[2];
                    
                    const ownerDataStart = line.indexOf(fullPropertyAddress) + fullPropertyAddress.length; 
                    const ownerAddressRaw = line.substring(ownerDataStart).trim();

                    let ownerName = '';
                    let mailingAddress = ownerAddressRaw;

                    const delimiters = ['—', ' L/E ', ' TR ', ' LLC ', ' INC ', ' ET AL '];
                    let delimiterIndex = -1;
                    let delimiterLength = 0;

                    for (const delim of delimiters) {
                        const rawDelimiter = line.substring(ownerDataStart).toUpperCase().indexOf(delim.trim().toUpperCase());
                        
                        if (rawDelimiter > -1 && (delimiterIndex === -1 || rawDelimiter < delimiterIndex)) {
                            delimiterIndex = rawDelimiter;
                            delimiterLength = delim.length;
                        }
                    }

                    if (delimiterIndex > -1) {
                        ownerName = ownerAddressRaw.substring(0, delimiterIndex).trim();
                        mailingAddress = ownerAddressRaw.substring(delimiterIndex + delimiterLength).trim().replace('—', '').trim();
                    } else {
                        const firstDigitIndex = ownerAddressRaw.search(/\d/);
                        if (firstDigitIndex > 10) { 
                            ownerName = ownerAddressRaw.substring(0, firstDigitIndex).trim();
                            mailingAddress = ownerAddressRaw.substring(firstDigitIndex).trim();
                        } else {
                            ownerName = ownerAddressRaw;
                            mailingAddress = "Missing mailing address or format requires manual review.";
                        }
                    }
                    
                    ownerName = ownerName.replace(/,,/g, ',').replace(/\s+/g, ' ').trim();
                    mailingAddress = mailingAddress.replace(/,,/g, ',').replace(/\s+/g, ' ').trim();

                    mailingAddress = mailingAddress.replace(/,\s*PUNTA GORDA FL\s*(\d{5})/, '').trim(); 
                    
                    dataMap[unitId] = {
                        building: propertyAddressMatch[1],
                        owner: ownerName,
                        address: mailingAddress,
                    };
                }
            });
            return dataMap;
        }

        /**
         * Renders the unit map for a given building.
         */
        function renderMap(containerId, unitList) {
            const container = document.getElementById(containerId);
            // Clear only on initial render
            if (container.children.length === 0) {
                 unitList.forEach(unit => {
                    const isDataAvailable = unitInfoData[unit] !== undefined;
                    
                    const unitElement = document.createElement('div');
                    let classes = 'unit';

                    if (unit === 'N/A') {
                        classes += ' inactive bg-gray-100';
                        unitElement.textContent = ''; 
                    } else if (!isDataAvailable) {
                        classes += ' inactive';
                        unitElement.textContent = unit;
                    } else {
                        unitElement.textContent = unit;
                        unitElement.addEventListener('click', () => handleUnitClick(unitElement, unit));
                    }

                    unitElement.className = classes;
                    unitElement.id = `unit-${unit}`;
                    unitElement.dataset.unitId = unit;

                    container.appendChild(unitElement);
                });
            }
        }
        
        /**
         * Applies the correct color classes to a unit element based on its market status.
         */
        function updateUnitColor(unitId) {
            const unitElement = document.getElementById(`unit-${unitId}`);
            if (!unitElement || unitElement.classList.contains('inactive')) return;

            const status = allUnitStatuses[unitId] || { forSale: false, rental: false };

            // Remove existing market classes
            unitElement.classList.remove('for-sale', 'rental');
            
            // Apply new classes
            if (status.forSale) {
                unitElement.classList.add('for-sale');
            }
            if (status.rental) {
                unitElement.classList.add('rental');
            }
        }
        
        /**
         * Iterates over all known units and updates their colors based on global state.
         */
        function updateAllUnitColors() {
            document.querySelectorAll('.unit').forEach(unitElement => {
                const unitId = unitElement.dataset.unitId;
                if (unitId && unitId !== 'N/A') {
                    updateUnitColor(unitId);
                }
            });
        }
        
        /**
         * Renders the market status controls (checkboxes).
         */
        function renderMarketStatusControls(unitId, marketSection) {
            // Get status from the global state, which is synced with Firestore
            const currentStatus = allUnitStatuses[unitId] || { forSale: false, rental: false };
            marketSection.style.display = 'flex';
            marketSection.style.flexDirection = 'column';
            
            marketSection.innerHTML = `
                <h3 class="font-semibold text-indigo-600">Market Status (Real-Time Shared):</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="for-sale-checkbox" ${currentStatus.forSale ? 'checked' : ''}>
                    <label for="for-sale-checkbox" class="text-orange-600">For Sale (Orange)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="rental-checkbox" ${currentStatus.rental ? 'checked' : ''}>
                    <label for="rental-checkbox" class="text-blue-600">Rental (Blue)</label>
                </div>
                <div class="checkbox-group mt-2">
                    <label class="text-red-600 font-bold">Both checked = Red</label>
                </div>
            `;
            // Set up listeners after elements are created
            setupMarketStatusListeners(unitId);
        }
        
        /**
         * Sets up the event listeners for the market status checkboxes.
         */
        function setupMarketStatusListeners(unitId) {
            const saleCheckbox = document.getElementById('for-sale-checkbox');
            const rentalCheckbox = document.getElementById('rental-checkbox');
            
            if (!saleCheckbox || !rentalCheckbox) return;

            // Attach new listeners
            const saveHandler = () => {
                const newStatus = {
                    forSale: saleCheckbox.checked,
                    rental: rentalCheckbox.checked
                };
                // Call asynchronous save function to persist to Firestore
                saveStatusesToFirestore(unitId, newStatus);
            };

            saleCheckbox.onchange = saveHandler;
            rentalCheckbox.onchange = saveHandler;
        }

        /**
         * Handles the click event on a unit.
         */
        function handleUnitClick(element, unitId) {
            // 1. Remove 'active' class from all units
            document.querySelectorAll('.unit').forEach(u => u.classList.remove('active'));
            
            // 2. Set new active unit ID and class
            activeUnitId = unitId;
            element.classList.add('active');

            // 3. Update info panel (including checkbox state/listeners)
            updateInfoPanel(unitId);
        }

        /**
         * Updates the information panel with data for the selected unit and sets up controls.
         */
        function updateInfoPanel(unitId) {
            const data = unitInfoData[unitId];
            const marketSection = document.getElementById('market-status-section');
            marketSection.className = 'market-status-controls'; 

            if (!data) {
                document.getElementById('info-title').textContent = `Unit ${unitId} Details (Data Missing)`;
                document.getElementById('owner-name').textContent = 'N/A';
                document.getElementById('mailing-address').textContent = 'N/A';
                marketSection.style.display = 'none';
                return;
            }
            
            document.getElementById('info-title').textContent = `Unit ${unitId} Details`;
            document.getElementById('owner-name').textContent = data.owner || 'N/A';
            document.getElementById('mailing-address').textContent = data.address || 'N/A';
            
            // Render controls
            renderMarketStatusControls(unitId, marketSection);
        }


        // --- Main Application Start ---
        window.onload = function() {
            // 1. Initialize Firebase and start listening for real-time changes
            initializeFirebase();
            
            // 2. Parse static unit owner data
            unitInfoData = parseData();

            // 3. Define unit maps
            const map_3170 = [
                '111', '112', '113', '114',
                '115', '116', '117', '118',
                '121', '122', '123', '124',
                '125', '126', 
                '127', '128',
                '131', '132', '133', '134',
                '135', 'N/A', '137', '138' 
            ];
            const map_3160 = [
                '211', '212', '213', '214', 
                '215', '216', '217', '218',
                '221', '222', '223', '224',
                '225', '226', '227', '228',
                '231', '232', '233', '234',
                '235', '236', '237', '238'
            ];
            
            // 4. Render maps 
            renderMap('grid-3170', map_3170);
            renderMap('grid-3160', map_3160);

            // 5. Select a default unit for the info panel to show
            const defaultUnitId = '211';
            const defaultUnitElement = document.getElementById(`unit-${defaultUnitId}`);
            if (defaultUnitElement) {
                handleUnitClick(defaultUnitElement, defaultUnitId);
            }
        };
    </script>
</body>
</html>
