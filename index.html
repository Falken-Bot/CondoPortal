<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matecumbe Key Property Portal - Real-Time Status</title>
    
    <style>
        /* Base Colors & Typography (Using standard Tailwind-like classes) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            min-height: 100vh;
            padding: 1rem; /* p-4 */
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* Responsive Padding for Header */
        @media (min-width: 768px) {
            body {
                padding: 2rem; /* md:p-8 */
            }
        }

        /* Utility Classes */
        .mx-auto { margin-left: auto; margin-right: auto; }
        .max-w-7xl { max-width: 80rem; }
        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 2.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-4 { padding: 1rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }

        /* Header Styling */
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .font-extrabold { font-weight: 800; }
        .text-indigo-700 { color: #4338ca; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-600 { color: #4b5563; }
        
        /* Main Content Layout (Desktop/Mobile) */
        #main-content-layout {
            display: flex;
            flex-direction: column; 
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        #map-section, #info-section {
            width: 100%; 
        }

        @media (min-width: 1024px) { 
            #main-content-layout {
                flex-direction: row; 
            }

            #map-section {
                width: 66.666667%; 
            }
            
            #info-section {
                width: 33.333333%; 
            }
            #info-panel {
                position: sticky;
                top: 1rem;
            }
        }
        
        /* Information Panel Styling */
        #info-panel {
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); 
            border-top: 4px solid #6366f1; 
        }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: #1f2937; }
        .text-indigo-600 { color: #4f46e5; }
        .italic { font-style: italic; }
        .text-gray-500 { color: #6b7280; }
        
        /* Unit Map Container Grid */
        .unit-map-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .unit-map-container {
                grid-template-columns: 1fr 1fr; 
            }
        }

        /* Individual Building Styling */
        .building-card h2 {
            font-size: 1.25rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            text-align: center;
            color: #4f46e5; 
            padding: 0.5rem; 
            background-color: #e0e7ff; 
        }
        
        /* Building Grid (4 columns inside each building) */
        .building-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 4px;
            padding: 16px;
            border: 2px solid #6366f1; 
            border-radius: 12px;
            background-color: #eef2ff; 
        }

        .unit {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px; 
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937; 
            background-color: #f7f8ff; 
            border: 1px solid #d1d5db; 
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none; 
            opacity: 0.8; /* Slightly less opaque until data confirms it's not inactive */
        }

        .unit:hover:not(.inactive) {
            background-color: #fcd34d; 
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .unit.active {
            box-shadow: 0 0 0 4px #818cf8, 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Highlighted active state */
            transform: scale(1.02);
            opacity: 1;
        }

        .unit.inactive {
            background-color: #e5e7eb; 
            color: #9ca3af; 
            cursor: default;
            opacity: 0.6;
        }
        
        .unit.inactive.bg-gray-100 { 
            background-color: #f3f4f6; 
            border-style: dashed;
        }

        /* Market Status Colors */
        .unit.for-sale {
            background-color: #f97316; /* Orange */
            color: #fff;
            border-color: #ea580c; 
            opacity: 1;
        }

        .unit.rental {
            background-color: #3b82f6; /* Blue */
            color: #fff;
            border-color: #2563eb; 
            opacity: 1;
        }
        
        /* Both Active (Red) - Highest precedence */
        .unit.for-sale.rental {
            background-color: #ef4444; /* Red */
            color: #fff;
            border-color: #dc2626; 
            opacity: 1;
        }
        
        /* Styling for the checkbox section */
        .market-status-controls {
            display: none; /* Hide until logic determines if enabled or disabled message should show */
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #d1d5db; 
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        .checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        .checkbox-group label {
            cursor: pointer;
        }
        
        /* Tailwind-based colors for checkbox labels */
        .text-orange-600 { color: #f97316; }
        .text-blue-600 { color: #3b82f6; }
        .text-red-600 { color: #ef4444; }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">Matecumbe Key Unit Map</h1>
            <p class="text-lg text-gray-600 mt-2">Click a unit to view owner information and set market status.</p>
        </header>

        <!-- Status Message & User ID -->
        <div id="status-message" class="text-center text-sm mb-4 p-2 rounded-lg bg-yellow-100 text-yellow-800">
            Initializing application and connecting to database...
        </div>

        <!-- Main Content Area -->
        <div id="main-content-layout">
            
            <!-- Unit Map Section -->
            <div id="map-section">
                <div class="unit-map-container">
                    <!-- Building 3170 -->
                    <div id="building-3170-map" class="building-card">
                        <h2>Building 3170 (Matecumbe Key Rd)</h2>
                        <div class="building-grid" id="grid-3170">
                            <!-- Units will be inserted here by JavaScript -->
                        </div>
                        <p class="text-sm text-center text-gray-500 mt-2">Units 111-138 (Schematic View)</p>
                    </div>

                    <!-- Building 3160 -->
                    <div id="building-3160-map" class="building-card">
                        <h2>Building 3160 (Matecumbe Key Rd)</h2>
                        <div class="building-grid" id="grid-3160">
                             <!-- Units will be inserted here by JavaScript -->
                        </div>
                        <p class="text-sm text-center text-gray-500 mt-2">Units 211-238 (Schematic View)</p>
                    </div>
                </div>
            </div>

            <!-- Information Panel Section -->
            <div id="info-section">
                <div id="info-panel" class="p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800" id="info-title">Select a Unit</h2>
                    <div id="info-content" class="text-gray-700">
                        <p>Click on any unit in the map to the left to display the owner's details here.</p>
                        
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-semibold text-indigo-600">Owner Name:</h3>
                            <p id="owner-name" class="italic text-gray-500" style="word-break: break-word;">Awaiting selection...</p>
                            
                            <h3 class="font-semibold text-indigo-600 mt-3">Mailing Address:</h3>
                            <p id="mailing-address" class="italic text-gray-500" style="word-break: break-word;">Awaiting selection...</p>
                        </div>
                        
                        <!-- Market Status Controls -->
                        <div id="market-status-section" class="market-status-controls">
                            <!-- Content will be injected by JavaScript based on isRealtimeEnabled -->
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let isAuthenticated = false; // Flag for successful sign-in
        let isRealtimeEnabled = false; // Flag for active database connection and saving ability
        let userId = null;
        let allUnitStatuses = {}; // Global state for market statuses from Firestore
        let activeUnitId = null; // Store the ID of the currently selected unit

        // Set log level to see Firebase internal logs (helpful for debugging)
        setLogLevel('Debug');
        
        // Helper function for a small delay
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- STATIC RAW DATA (RETAINED) ---
        const RAW_DATA = `3170 MATECUMBE KEY RD 111, Punta Gorda FL 33955 WYNNIK DARREN T + WYNNIK HEATHER Z — 3553 Potato Garden Run Rd, Imperial PA 15126
3170 MATECUMBE KEY RD 112, Punta Gorda FL 33955 FUNK SHEILA TR (For Sheila Funk Trust) — 473 Edgewater Dr, Morris IL 60450
3170 MATECUMBE KEY RD 113, Punta Gorda FL 33955 ENGKJER WANE S TR (For Waterfront Trust) — 51628 Pelican Point Dr, Detroit Lakes MN 56501
3170 MATECUMBE KEY RD 114, Punta Gorda FL 33955 2ND BILL RENTALS LLC — 17917 Courtside Landings Cir,, Punta Gorda FL 33955
3170 MATECUMBE KEY RD 115, Punta Gorda FL 33955 ORSINI WENDY L — P.O. Box 242, Pellston MI 49769
3170 MATECUMBE KEY RD 116, Punta Gorda FL 33955 HUFFMAN W ALAN + KATHRYN R TR (For W Alan Huffman Trust) — 4080 Cape Cole Blvd,, Punta Gorda FL 33955
3170 MATECUMBE KEY RD 117, Punta Gorda FL 33955 TENNYSON CHRISTOPHER + LISA — 69 Pine Valley Ct, Rotonda West FL 33947
3170 MATECUMBE KEY RD 118, Punta Gorda FL 33955 GREEN PETER + CLINTON RITA — 3870 Ontario Dr, North Tonawanda NY 14120
3170 MATECUMBE KEY RD 121, Punta Gorda FL 33955 HOLBEIN MARK ALLEN — 103 McIntyre Ln, Freeport PA 16229
3170 MATECUMBE KEY RD 122, Punta Gorda FL 33955 MANJ LLC — P.O. Box 682, Park Ridge IL 60068
3170 MATECUMBE KEY RD 123, Punta GORDA FL 33955 HOLBEIN MARK ALLEN 103 MCNTY RE LN FREEPORT PA 16229
3170 MATECUMBE KEY RD 124, Punta GORDA FL 33955 LONERGAN MARK S 1812 NE 44TH ST CAPE CORAL FL 33909
3170 MATECUMBE KEY RD 125, Punta GORDA FL 33955 SIMPSON JUDY 2545 DIANE AVE NORTH HUNTINGDON PA 15642
3170 MATECUMBE KEY RD 126, Punta GORDA FL 33955 LEVENDOFSKY LISA J 1321 VIA TOSCANA WAY SUN CITY CENTER FL 33573
3170 MATECUMBE KEY RD 127, Punta GORDA FL 33955 PERRAUD ROBERT C & PERRAUD CYNTHIA M PERRAUD TRUST 1910 E COCKATOO LN MELBOURNE BEACH FL 32951
3170 MATECUMBE KEY RD 128, Punta GORDA FL 33955 PETTY ROBERT R & JUDITH N 2511 CARDINAL HARBOUR RD PROSPECT KY 40059
3170 MATECUMBE KEY RD 131, Punta GORDA FL 33955 JENNINGS STEVEN + GROTHE DARLA — 3170 MATECUMBE KEY RD 131, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 132, Punta GORDA FL 33955 ANDERSON MICHAEL P & ZIEGENHORN CATHERINE 7455 BOCA VISTA ROAD, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 133, Punta GORDA FL 33955 SHANNON GERALD T TR FOR SHANNON TRUST PO BOX 775 WAKEFIELD ME 04086
3170 MATECUMBE KEY RD 134, Punta GORDA FL 33955 LIBBY ROBERT W & CYNTHIA F 463 OLD MEETINGHOUSE RD PORTER ME 04068
3170 MATECUMBE KEY RD 135, Punta GORDA FL 33955 FOLIO ANTHONY J 3170 MATECUMBE KEY RD #135, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 137, Punta GORDA FL 33955 LINDAHL JULIE 3170 MATECUMBE KEY RD #137, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 138, Punta GORDA FL 33955 CALL WILLIAM H JR & CALL BOBBI JD 3 STEVEN LN STEEP FALLS ME 04085
3160 MATECUMBE KEY RD 235 PUNTA GORDA FL 33955 KLADE BEATRICE 27W070 80TH ST NAPERVILLE IL 60565
3160 MATECUMBE KEY RD 236 PUNTA GORDA FL 33955 FLAHERTY JEFFREY SCOTT 905 CROSSING DR COVINGTON KY 41017
3160 MATECUMBE KEY RD 237 PUNTA GORDA FL 33955 AMMONS MAURICE ALLEN III + AMMONS DEBRA ENGLERT 1613 ST THOMAS DR MIDLOTHIAN VA 23114
3160 MATECUMBE KEY RD 238 PUNTA GORDA FL 33955 BASHAM DAVID W L/E 4581 N PASEO DE LOS CERRITOS TUCSON AZ 85745
3160 MATECUMBE KEY RD 223 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 224 PUNTA GORDA FL 33955 LEGER GERALD F & AMY L 25 ERIE LN GROTON CT 06340
3160 MATECUMBE KEY RD 225 PUNTA GORDA FL 33955 MARSHALL LARRY 3160 MATECUMBE KEY RD #225 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 226 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 227 PUNTA GORDA FL 33955 STEFANSKI PETER 3605 S MAYFIELD RD JACKSON WI 53037
3160 MATECUMBE KEY RD 228 PUNTA GORDA FL 33955 BADILLO LUIS & SANDRA 3160 MATECUMBE KEY RD #228 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 231 PUNTA GORDA FL 33955 HARWOOD GERALD W & HARWOOD JACQUELYN H 5198 ARROWWOOD DR PARK CITY UT 84098
3160 MATECUMBE KEY RD 232 PUNTA GORDA FL 33955 TRAVER-MUZIO SHARRON E + OBRIEN PHILLIP E L/E 24707 CEDAR RIDGE LANDINGS CIR PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 233 PUNTA GORDA FL 33955 MCDONAGH BARBARA A 5 ROCKY HOOK WALDEN MA 01880
3160 MATECUMBE KEY RD 234 PUNTA GORDA FL 33955 VECCHIARELLI ANGELO A + CARMONA BRENDA J 191 FLOWERING RIDGE RD WHITTIER NC 28789
3160 MATECUMBE KEY RD 211 PUNTA GORDA FL 33955 SANDERS KENNETH H III & SANDERS ROBERTA F + CLARK J A III ET AL 4919 GABRIEL LN WAUCHULA FL 33873
3160 MATECUMBE KEY RD 212 PUNTA GORDA FL 33955 SCOTT JOSEPH & TERRI LYNN 7996 AQUA ISLE CLAY MI 48001
3160 MATECUMBE KEY RD 213 PUNTA GORDA FL 33955 ANTHONSEN GARY 3797 PLUECKHAHN LANDINGS CIR PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 214 PUNTA GORDA FL 33955 LALONE DEREK J & NANETTE M 7779 COLONY DR CLAY MI 48001
3160 MATECUMBE KEY RD 215 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 216 PUNTA GORDA FL 33955 WHELAN WILLIAM W & WHELAN BARBARA W TR TRUST 3245 SUGARLOAF KEY RD #216 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 217 PUNTA GORDA FL 33955 WEGENER JAMES W & BEVERLY S 9624 DUNES DR FORT PIERCE SD 57532
3160 MATECUMBE KEY RD 218 PUNTA GORDA FL 33955 TANNOUS BETH ANN 3160 MATECUMBE KEY RD #218 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 221 PUNTA GORDA FL 33955 JOE S AUTOWHOLESALE INC 5708 RALEIGH DR NORFOLK VA 23502
3160 MATECUMBE KEY RD 222 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 27W070 80TH ST NAPERVILLE IL 60565`;


        let unitInfoData = {}; 

        // --- Firebase Setup and Real-Time Listener ---

        /**
         * Gets the Firestore collection reference for public unit statuses.
         */
        function getUnitStatusCollectionRef() {
            if (!db) return null;
            // Public data path: /artifacts/{appId}/public/data/{collectionName}
            const collectionPath = `artifacts/${appId}/public/data/unitStatuses`;
            return collection(db, collectionPath);
        }

        /**
         * Parses the Firebase configuration from the global environment variable.
         * Tries to wait for the configuration to be injected with multiple retries.
         * @param {number} retries - The number of times to try to fetch the config.
         * @param {number} delay - The delay in milliseconds between retries.
         * @returns {Promise<Object>} The parsed firebase config object.
         */
        async function getFirebaseConfigWithRetry(retries = 15, delay = 200) {
            let firebaseConfig = {};
            const statusMessageElement = document.getElementById('status-message');
            
            // Wait for up to 3 seconds total (15 retries * 200ms)
            for (let i = 0; i < retries; i++) {
                
                let configAttempt = null;
                const rawConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

                // 1. Check if the config variable exists
                if (rawConfig) {
                    
                    if (typeof rawConfig === 'string' && rawConfig.trim() !== '') {
                        // Standard behavior: parse the string
                        try {
                            configAttempt = JSON.parse(rawConfig);
                        } catch (e) {
                            console.error(`[CRITICAL ERROR] Attempt ${i + 1}: Failed to parse __firebase_config JSON:`, e);
                            break; 
                        }
                    } else if (typeof rawConfig === 'object' && rawConfig !== null) {
                        // Defensive check for non-standard injection as an object
                        configAttempt = rawConfig;
                    }
                    
                    // 2. Check if the config is valid
                    if (configAttempt && configAttempt.apiKey) {
                        console.log(`[SUCCESS] Attempt ${i + 1}: Firebase config found and valid.`);
                        return configAttempt;
                    } else if (configAttempt) {
                        console.warn(`[WARNING] Attempt ${i + 1}: __firebase_config found, but is missing 'apiKey' field.`);
                    }
                }
                
                // If we haven't succeeded, log and wait
                console.log(`[RETRY] Attempt ${i + 1}: __firebase_config is missing or invalid. Waiting...`);
                
                // Update status message on UI
                statusMessageElement.textContent = `Attempting to load configuration... (Attempt ${i + 1}/${retries}). Please wait up to 3 seconds.`;
                await sleep(delay);
            }
            return {}; // Return empty object if all retries fail
        }


        /**
         * Initializes Firebase and returns a Promise that resolves when authentication is complete.
         */
        async function initializeFirebase() {
            const statusMessageElement = document.getElementById('status-message');
            statusMessageElement.textContent = 'Connecting to database...';
            statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-yellow-100 text-yellow-800';

            // 1. Get configuration, waiting with retry logic
            const firebaseConfig = await getFirebaseConfigWithRetry();

            // 2. CRITICAL CHECK: Ensure the parsed config is valid
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                const msg = 'CONFIGURATION MISSING: Real-time features disabled. Please ensure the hosting environment provides a valid Firebase config.';
                console.error(msg);
                statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-red-100 text-red-800';
                statusMessageElement.textContent = msg;
                // Important: Update the market status section immediately to show 'DISABLED'
                updateMarketStatusSectionForDisabledState();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token successfully.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
                
                const user = auth.currentUser;

                if (user) {
                    userId = user.uid;
                    isAuthenticated = true;
                    isRealtimeEnabled = true; // Success!
                    
                    statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-green-100 text-green-800';
                    statusMessageElement.textContent = `Connected (User ID: ${userId.substring(0, 8)}...). Status updates are real-time.`;
                    
                    startRealTimeStatusListener();
                } else {
                    // This block catches the authentication failure
                    throw new Error("User object is null after sign-in attempt (Authentication Failed).");
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-in failed:", error);
                isAuthenticated = false;
                isRealtimeEnabled = false;
                const msg = 'SAVING DISABLED Reason: AUTHENTICATION FAILED: Status updates will not be saved (Read-Only Mode).';
                statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-red-100 text-red-800';
                statusMessageElement.textContent = msg;
                updateMarketStatusSectionForDisabledState();
            }
        }
        
        /**
         * Starts the real-time listener for unit statuses.
         */
        function startRealTimeStatusListener() {
            const unitStatusColRef = getUnitStatusCollectionRef();
            if (!unitStatusColRef) return;
            
            // Listen for changes across the entire 'unitStatuses' collection
            onSnapshot(unitStatusColRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") {
                        const unitId = change.doc.id;
                        const status = change.doc.data();
                        
                        // 1. Update the global state
                        allUnitStatuses[unitId] = status;
                        
                        // 2. Update the unit square color on the map
                        updateUnitColor(unitId, status);
                        
                        // 3. If the changed unit is the currently selected one, update the checkbox UI
                        if (unitId === activeUnitId) {
                            updateInfoPanel(unitId); // Re-run to update checkboxes and info
                        }
                    } else if (change.type === "removed") {
                        // Clear status if removed
                        const unitId = change.doc.id;
                        allUnitStatuses[unitId] = { forSale: false, rental: false };
                        updateUnitColor(unitId, { forSale: false, rental: false });
                    }
                });
            }, (error) => {
                console.error("Firestore listening failed:", error);
            });
        }

        /**
         * Saves market status for a unit to Firestore.
         * @param {string} unitId 
         * @param {{forSale: boolean, rental: boolean}} status 
         */
        async function saveMarketStatus(unitId, status) {
            const statusMessageElement = document.getElementById('status-message');
            
            if (!isRealtimeEnabled || !db || !userId) {
                console.warn("Real-time saving is disabled. Cannot save status.");
                
                const marketSection = document.getElementById('market-status-section');
                
                // Temporarily display the failure message in the info panel
                updateMarketStatusSectionForDisabledState(marketSection);
                
                // Revert UI after 4s (but only if the unit is still active)
                setTimeout(() => { if(unitId === activeUnitId) updateInfoPanel(unitId); }, 4000); 
                return;
            }
            
            // Temporary visual feedback while waiting for network response
            statusMessageElement.textContent = 'Saving unit status...';
            statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-blue-100 text-blue-800';


            try {
                // Ensure data is valid before saving
                const dataToSave = { 
                    forSale: !!status.forSale, 
                    rental: !!status.rental 
                };
                
                const docRef = doc(getUnitStatusCollectionRef(), unitId);
                // setDoc merges existing data if the document already exists
                await setDoc(docRef, dataToSave, { merge: true }); 
                
                // Success feedback - the listener will update the grid, but we update the main status bar
                statusMessageElement.textContent = `Connected (User ID: ${userId.substring(0, 8)}...). Status updates are real-time.`;
                statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-green-100 text-green-800';

            } catch (error) {
                console.error("FATAL ERROR: Failed to save market status to Firestore. Check security rules or connection:", error);
                statusMessageElement.textContent = `ERROR: Failed to save status for unit ${unitId}. See console for details.`;
                statusMessageElement.className = 'text-center text-sm mb-4 p-2 rounded-lg bg-red-100 text-red-800';
            }
        }
        
        // --- UI and Data Logic ---

        /**
         * Parses the raw text data into a structured JavaScript object.
         */
        function parseData() {
            const lines = RAW_DATA.trim().split('\n');
            const dataMap = {};
            
            lines.forEach(line => {
                const propertyAddressMatch = line.match(/(31\d{2}) MATECUMBE KEY RD\s*(\d{3}),?\s*Punta GORDA FL\s*(\d{5})/i);

                if (propertyAddressMatch) {
                    const fullPropertyAddress = propertyAddressMatch[0]; 
                    const unitId = propertyAddressMatch[2];
                    
                    const ownerDataStart = line.indexOf(fullPropertyAddress) + fullPropertyAddress.length; 
                    const ownerAddressRaw = line.substring(ownerDataStart).trim();

                    let ownerName = '';
                    let mailingAddress = ownerAddressRaw;

                    // Common delimiters used in the raw data to separate Name and Address
                    const delimiters = ['—', ' L/E ', ' TR ', ' LLC ', ' INC ', ' ET AL '];
                    let delimiterIndex = -1;
                    let delimiterLength = 0;

                    // Find the first delimiter to separate owner name from mailing address
                    for (const delim of delimiters) {
                        // Use case-insensitive search logic for the delimiter in the raw string
                        const rawDelimiter = line.substring(ownerDataStart).toUpperCase().indexOf(delim.trim().toUpperCase());
                        
                        // We must ensure this delimiter is not part of the address section itself, 
                        // but since the original logic was simple, we stick to finding the first occurrence
                        if (rawDelimiter > -1 && (delimiterIndex === -1 || rawDelimiter < delimiterIndex)) {
                            delimiterIndex = rawDelimiter;
                            delimiterLength = delim.length;
                        }
                    }

                    if (delimiterIndex > -1) {
                        ownerName = ownerAddressRaw.substring(0, delimiterIndex).trim();
                        // Adjust address start by delimiter length
                        mailingAddress = ownerAddressRaw.substring(delimiterIndex + delimiterLength).trim().replace('—', '').trim();
                    } else {
                        // Fallback: look for first number as start of address (often the street number)
                        const firstDigitIndex = ownerAddressRaw.search(/\d/);
                        if (firstDigitIndex > 10) { 
                            ownerName = ownerAddressRaw.substring(0, firstDigitIndex).trim();
                            mailingAddress = ownerAddressRaw.substring(firstDigitIndex).trim();
                        } else {
                            ownerName = ownerAddressRaw;
                            mailingAddress = "Missing mailing address or format requires manual review.";
                        }
                    }
                    
                    ownerName = ownerName.replace(/,,/g, ',').replace(/\s+/g, ' ').trim();
                    mailingAddress = mailingAddress.replace(/,,/g, ',').replace(/\s+/g, ' ').trim();

                    // Clean up common suffix leftovers
                    mailingAddress = mailingAddress.replace(/,\s*PUNTA GORDA FL\s*(\d{5})/, '').trim(); 
                    
                    dataMap[unitId] = {
                        building: propertyAddressMatch[1],
                        owner: ownerName,
                        address: mailingAddress,
                    };
                }
            });
            return dataMap;
        }

        /**
         * Renders the unit map for a given building.
         */
        function renderMap(containerId, unitList) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            unitList.forEach(unit => {
                const isDataAvailable = unitInfoData[unit] !== undefined;
                
                const unitElement = document.createElement('div');
                let classes = 'unit';

                if (unit === 'N/A') {
                    classes += ' inactive bg-gray-100';
                    unitElement.textContent = ''; 
                } else if (!isDataAvailable) {
                    // This is for unit numbers without parsed data (shouldn't happen with current data)
                    classes += ' inactive';
                    unitElement.textContent = unit;
                } else {
                    unitElement.textContent = unit;
                    unitElement.addEventListener('click', () => handleUnitClick(unitElement, unit));
                }

                unitElement.className = classes;
                unitElement.id = `unit-${unit}`;
                unitElement.dataset.unitId = unit;

                container.appendChild(unitElement);
            });
        }
        
        /**
         * Applies the correct color classes to a unit element based on its market status.
         */
        function updateUnitColor(unitId, status) {
            const unitElement = document.getElementById(`unit-${unitId}`);
            if (!unitElement || unitElement.classList.contains('inactive')) return;

            // Remove existing market classes
            unitElement.classList.remove('for-sale', 'rental');
            
            // Remove active state unless it's the currently selected unit
            if (unitId !== activeUnitId) {
                 unitElement.classList.remove('active');
            }

            // Apply new classes
            if (status && status.forSale) {
                unitElement.classList.add('for-sale');
            }
            if (status && status.rental) {
                unitElement.classList.add('rental');
            }
        }
        
        /**
         * Renders the market status controls (either checkboxes or a disabled message).
         */
        function renderMarketStatusControls(unitId, marketSection) {
            const currentStatus = allUnitStatuses[unitId] || { forSale: false, rental: false };
            marketSection.style.display = 'flex';
            
            if (isRealtimeEnabled) {
                // Render active checkboxes
                marketSection.style.flexDirection = 'column';
                marketSection.innerHTML = `
                    <h3 class="font-semibold text-indigo-600">Market Status (Real-Time):</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="for-sale-checkbox" ${currentStatus.forSale ? 'checked' : ''}>
                        <label for="for-sale-checkbox" class="text-orange-600">For Sale (Orange)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rental-checkbox" ${currentStatus.rental ? 'checked' : ''}>
                        <label for="rental-checkbox" class="text-blue-600">Rental (Blue)</label>
                    </div>
                    <div class="checkbox-group mt-2">
                        <label class="text-red-600 font-bold">Both checked = Red</label>
                    </div>
                `;
                // Set up listeners after elements are created
                setupMarketStatusListeners(unitId);
            } else {
                // Render disabled message (Read-Only Mode)
                updateMarketStatusSectionForDisabledState(marketSection);
            }
        }
        
        /**
         * Renders the disabled state message in the market status section.
         * This function can be called on init failure or save attempt failure.
         */
        function updateMarketStatusSectionForDisabledState(marketSection = document.getElementById('market-status-section')) {
            const currentStatusMessage = document.getElementById('status-message').textContent;
            
            marketSection.style.flexDirection = 'column';
            marketSection.style.display = 'flex';
            marketSection.innerHTML = `
                <h3 class="font-semibold text-indigo-600">Market Status:</h3>
                <div class="p-3 bg-red-50 border border-red-300 rounded-lg">
                    <p class="text-red-700 font-bold text-sm">
                        <span style="font-size: 1.2em;">&#9888;</span> SAVING DISABLED
                    </p>
                    <p class="text-gray-600 text-xs mt-1">
                        Reason: ${currentStatusMessage}
                    </p>
                </div>
            `;
        }

        /**
         * Sets up the event listeners for the market status checkboxes.
         */
        function setupMarketStatusListeners(unitId) {
            const saleCheckbox = document.getElementById('for-sale-checkbox');
            const rentalCheckbox = document.getElementById('rental-checkbox');
            
            if (!saleCheckbox || !rentalCheckbox) return;

            // Attach new listeners
            const saveHandler = () => {
                const newStatus = {
                    forSale: saleCheckbox.checked,
                    rental: rentalCheckbox.checked
                };
                // Call async save function
                saveMarketStatus(unitId, newStatus);
                // UI update will be handled by the onSnapshot listener when the data syncs
            };

            saleCheckbox.onchange = saveHandler;
            rentalCheckbox.onchange = saveHandler;
        }

        /**
         * Handles the click event on a unit.
         */
        function handleUnitClick(element, unitId) {
            // 1. Store the currently active unit ID
            activeUnitId = unitId;
            
            // 2. Remove 'active' class from all units
            document.querySelectorAll('.unit').forEach(u => u.classList.remove('active'));
            
            // 3. Set new active unit
            element.classList.add('active');

            // 4. Update info panel (including checkbox state/listeners)
            updateInfoPanel(unitId);
        }

        /**
         * Updates the information panel with data for the selected unit and sets up controls.
         */
        function updateInfoPanel(unitId) {
            const data = unitInfoData[unitId];
            const marketSection = document.getElementById('market-status-section');
            marketSection.className = 'market-status-controls'; // Ensure base class is set

            if (!data) {
                document.getElementById('info-title').textContent = `Unit ${unitId} Details (Data Missing)`;
                document.getElementById('owner-name').textContent = 'N/A';
                document.getElementById('mailing-address').textContent = 'N/A';
                marketSection.style.display = 'none';
                return;
            }
            
            document.getElementById('info-title').textContent = `Unit ${unitId} Details`;
            document.getElementById('owner-name').textContent = data.owner || 'N/A';
            document.getElementById('mailing-address').textContent = data.address || 'N/A';
            
            // Render controls or disabled message based on connection status
            renderMarketStatusControls(unitId, marketSection);
        }


        // --- Main Application Start ---
        window.onload = async function() {
            // 1. Parse static data first
            unitInfoData = parseData();

            // 2. Define unit maps
            const map_3170 = [
                '111', '112', '113', '114',
                '115', '116', '117', '118',
                '121', '122', '123', '124',
                '125', '126', 
                '127', '128',
                '131', '132', '133', '134',
                '135', 'N/A', '137', '138' 
            ];
            const map_3160 = [
                '211', '212', '213', '214', 
                '215', '216', '217', '218',
                '221', '222', '223', '224',
                '225', '226', '227', '228',
                '231', '232', '233', '234',
                '235', '236', '237', '238'
            ];
            
            // 3. Render maps
            renderMap('grid-3170', map_3170);
            renderMap('grid-3160', map_3160);

            // 4. Initialize Firebase and wait for auth to complete
            try {
                // Now uses retry logic to wait for configuration injection
                await initializeFirebase();
            } catch (e) {
                console.error("Initialization error:", e);
            }
            
            // 5. Select a default unit (guaranteed to run after auth is stable)
            const defaultUnitId = '211';
            const defaultUnitElement = document.getElementById(`unit-${defaultUnitId}`);
            if (defaultUnitElement) {
                handleUnitClick(defaultUnitElement, defaultUnitId);
            }
        };
    </script>
</body>
</html>
