<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matecumbe Key Property Portal</title>
    
    <style>
        /* Base Colors & Typography */
        body {
            /* Using system default sans-serif font stack for max compatibility */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            min-height: 100vh;
            padding: 1rem; /* p-4 */
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* Responsive Padding for Header */
        @media (min-width: 768px) {
            body {
                padding: 2rem; /* md:p-8 */
            }
        }

        /* General Containers */
        .mx-auto { margin-left: auto; margin-right: auto; }
        .max-w-7xl { max-width: 80rem; }
        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 2.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-4 { padding: 1rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-t-lg { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }

        /* Header Styling */
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .font-extrabold { font-weight: 800; }
        .text-indigo-700 { color: #4338ca; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-600 { color: #4b5563; }
        
        /* Main Content Layout (Desktop/Mobile) */
        #main-content-layout {
            display: flex;
            flex-direction: column; /* Default stack on mobile */
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        #map-section, #info-section {
            width: 100%; 
        }

        @media (min-width: 1024px) { /* Desktop layout */
            #main-content-layout {
                flex-direction: row; /* Two columns on desktop */
            }

            #map-section {
                width: 66.666667%; /* 2/3 width */
            }
            
            #info-section {
                width: 33.333333%; /* 1/3 width */
            }
            #info-panel {
                position: sticky;
                top: 1rem;
            }
        }
        
        /* Information Panel Styling */
        #info-panel {
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-lg */
            border-top: 4px solid #6366f1; /* border-t-4 border-indigo-500 */
        }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-700 { color: #374151; }
        .bg-gray-50 { background-color: #f9fafb; }
        .font-semibold { font-weight: 600; }
        .text-indigo-600 { color: #4f46e5; }
        .italic { font-style: italic; }
        .text-gray-500 { color: #6b7280; }
        
        /* Tailwind-based colors for checkbox labels */
        .text-orange-600 { color: #f97316; }
        .text-blue-600 { color: #3b82f6; }
        .text-red-600 { color: #ef4444; }


        /* Unit Map Container Grid */
        .unit-map-container {
            display: grid;
            grid-template-columns: 1fr; /* Default stack on mobile */
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .unit-map-container {
                grid-template-columns: 1fr 1fr; /* Two columns for the buildings on tablet/desktop */
            }
        }

        /* Individual Building Styling */
        .building-card h2 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 1rem; /* mb-4 */
            text-align: center;
            color: #4f46e5; /* text-indigo-600 */
            padding: 0.5rem; /* p-2 */
            background-color: #e0e7ff; /* bg-indigo-100 */
        }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        
        /* Building Grid (4 columns inside each building) */
        .building-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 4px;
            padding: 16px;
            border: 2px solid #6366f1; /* indigo-500 */
            border-radius: 12px;
            background-color: #eef2ff; /* indigo-50 */
        }

        .unit {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px; 
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            /* Default background for interactive units (with data) is now a subtle light blue */
            background-color: #f7f8ff; 
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none; /* Prevent text selection on click */
        }

        .unit:hover {
            background-color: #fcd34d; /* yellow-400 */
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .unit.active {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            border-color: #4338ca; /* indigo-700 */
        }

        .unit.inactive {
            /* Gray background for units without data (non-clickable) */
            background-color: #e5e7eb; /* gray-200 */
            color: #9ca3af; /* gray-400 */
            cursor: default;
        }
        
        .unit.inactive.bg-gray-100 { /* For N/A placeholders */
            background-color: #f3f4f6; 
            border-style: dashed;
        }

        /* Market Status Colors */
        /* 1. For Sale (Orange) */
        .unit.for-sale {
            background-color: #f97316; /* orange-600 */
            color: #fff;
            border-color: #ea580c; /* orange-700 */
        }

        /* 2. Rental (Blue) */
        .unit.rental {
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
            border-color: #2563eb; /* blue-600 */
        }
        
        /* 3. NEW: Both Active (Red) - This selector takes precedence */
        .unit.for-sale.rental {
            background-color: #ef4444; /* red-500 */
            color: #fff;
            border-color: #dc2626; /* red-600 */
        }
        
        /* Styling for the checkbox section */
        .market-status-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #d1d5db; /* gray-300 */
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        .checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        .checkbox-group label {
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">Matecumbe Key Unit Map</h1>
            <p class="text-lg text-gray-600 mt-2">Click a unit to view owner information.</p>
        </header>

        <!-- Main Content Area -->
        <div id="main-content-layout">
            
            <!-- Unit Map Section -->
            <div id="map-section">
                <div class="unit-map-container">
                    <!-- Building 3170 -->
                    <div id="building-3170-map" class="building-card">
                        <h2>Building 3170 (Matecumbe Key Rd)</h2>
                        <div class="building-grid" id="grid-3170">
                            <!-- Units will be inserted here by JavaScript -->
                        </div>
                        <p class="text-sm text-center text-gray-500 mt-2">Units 111-138 (Schematic View)</p>
                    </div>

                    <!-- Building 3160 -->
                    <div id="building-3160-map" class="building-card">
                        <h2>Building 3160 (Matecumbe Key Rd)</h2>
                        <div class="building-grid" id="grid-3160">
                             <!-- Units will be inserted here by JavaScript -->
                        </div>
                        <p class="text-sm text-center text-gray-500 mt-2">Units 211-238 (Schematic View)</p>
                    </div>
                </div>
            </div>

            <!-- Information Panel Section -->
            <div id="info-section">
                <div id="info-panel" class="p-6 rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800" id="info-title">Select a Unit</h2>
                    <div id="info-content" class="text-gray-700">
                        <p>Click on any unit in the map to the left to display the owner's details here.</p>
                        
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-semibold text-indigo-600">Owner Name:</h3>
                            <p id="owner-name" class="italic text-gray-500" style="word-break: break-word;">Awaiting selection...</p>
                            
                            <h3 class="font-semibold text-indigo-600 mt-3">Mailing Address:</h3>
                            <p id="mailing-address" class="italic text-gray-500" style="word-break: break-word;">Awaiting selection...</p>
                        </div>
                        
                        <!-- NEW: Market Status Controls -->
                        <div id="market-status-section" class="market-status-controls">
                            <h3 class="font-semibold text-indigo-600">Market Status:</h3>
                            <div class="checkbox-group">
                                <input type="checkbox" id="for-sale-checkbox">
                                <label for="for-sale-checkbox" class="text-orange-600">For Sale (Orange)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="rental-checkbox">
                                <label for="rental-checkbox" class="text-blue-600">Rental (Blue)</label>
                            </div>
                            <div class="checkbox-group mt-2">
                                <label class="text-red-600 font-bold">Both checked = Red</label>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Raw data provided by the user (embedded directly into the script)
        const RAW_DATA = `3170 MATECUMBE KEY RD 111, Punta Gorda FL 33955 WYNNIK DARREN T + WYNNIK HEATHER Z — 3553 Potato Garden Run Rd, Imperial PA 15126
3170 MATECUMBE KEY RD 112, Punta Gorda FL 33955 FUNK SHEILA TR (For Sheila Funk Trust) — 473 Edgewater Dr, Morris IL 60450
3170 MATECUMBE KEY RD 113, Punta Gorda FL 33955 ENGKJER WANE S TR (For Waterfront Trust) — 51628 Pelican Point Dr, Detroit Lakes MN 56501
3170 MATECUMBE KEY RD 114, Punta Gorda FL 33955 2ND BILL RENTALS LLC — 17917 Courtside Landings Cir,, Punta Gorda FL 33955
3170 MATECUMBE KEY RD 115, Punta Gorda FL 33955 ORSINI WENDY L — P.O. Box 242, Pellston MI 49769
3170 MATECUMBE KEY RD 116, Punta Gorda FL 33955 HUFFMAN W ALAN + KATHRYN R TR (For W Alan Huffman Trust) — 4080 Cape Cole Blvd,, Punta Gorda FL 33955
3170 MATECUMBE KEY RD 117, Punta Gorda FL 33955 TENNYSON CHRISTOPHER + LISA — 69 Pine Valley Ct, Rotonda West FL 33947
3170 MATECUMBE KEY RD 118, Punta Gorda FL 33955 GREEN PETER + CLINTON RITA — 3870 Ontario Dr, North Tonawanda NY 14120
3170 MATECUMBE KEY RD 121, Punta Gorda FL 33955 HOLBEIN MARK ALLEN — 103 McIntyre Ln, Freeport PA 16229
3170 MATECUMBE KEY RD 122, Punta Gorda FL 33955 MANJ LLC — P.O. Box 682, Park Ridge IL 60068
3170 MATECUMBE KEY RD 123, Punta GORDA FL 33955 HOLBEIN MARK ALLEN 103 MCNTY RE LN FREEPORT PA 16229
3170 MATECUMBE KEY RD 124, Punta GORDA FL 33955 LONERGAN MARK S 1812 NE 44TH ST CAPE CORAL FL 33909
3170 MATECUMBE KEY RD 125, Punta GORDA FL 33955 SIMPSON JUDY 2545 DIANE AVE NORTH HUNTINGDON PA 15642
3170 MATECUMBE KEY RD 126, Punta GORDA FL 33955 LEVENDOFSKY LISA J 1321 VIA TOSCANA WAY SUN CITY CENTER FL 33573
3170 MATECUMBE KEY RD 127, Punta GORDA FL 33955 PERRAUD ROBERT C & PERRAUD CYNTHIA M PERRAUD TRUST 1910 E COCKATOO LN MELBOURNE BEACH FL 32951
3170 MATECUMBE KEY RD 128, Punta GORDA FL 33955 PETTY ROBERT R & JUDITH N 2511 CARDINAL HARBOUR RD PROSPECT KY 40059
3170 MATECUMBE KEY RD 131, Punta GORDA FL 33955 
3170 MATECUMBE KEY RD 132, Punta GORDA FL 33955 ANDERSON MICHAEL P & ZIEGENHORN CATHERINE 7455 BOCA VISTA ROAD, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 133, Punta GORDA FL 33955 SHANNON GERALD T TR FOR SHANNON TRUST PO BOX 775 WAKEFIELD ME 04086
3170 MATECUMBE KEY RD 134, Punta GORDA FL 33955 LIBBY ROBERT W & CYNTHIA F 463 OLD MEETINGHOUSE RD PORTER ME 04068
3170 MATECUMBE KEY RD 135, Punta GORDA FL 33955 FOLIO ANTHONY J 3170 MATECUMBE KEY RD #135, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 137, Punta GORDA FL 33955 LINDAHL JULIE 3170 MATECUMBE KEY RD #137, Punta GORDA FL 33955
3170 MATECUMBE KEY RD 138, Punta GORDA FL 33955 CALL WILLIAM H JR & CALL BOBBI JD 3 STEVEN LN STEEP FALLS ME 04085
3160 MATECUMBE KEY RD 235 PUNTA GORDA FL 33955 KLADE BEATRICE 27W070 80TH ST NAPERVILLE IL 60565
3160 MATECUMBE KEY RD 236 PUNTA GORDA FL 33955 FLAHERTY JEFFREY SCOTT 905 CROSSING DR COVINGTON KY 41017
3160 MATECUMBE KEY RD 237 PUNTA GORDA FL 33955 AMMONS MAURICE ALLEN III + AMMONS DEBRA ENGLERT 1613 ST THOMAS DR MIDLOTHIAN VA 23114
3160 MATECUMBE KEY RD 238 PUNTA GORDA FL 33955 BASHAM DAVID W L/E 4581 N PASEO DE LOS CERRITOS TUCSON AZ 85745
3160 MATECUMBE KEY RD 223 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 224 PUNTA GORDA FL 33955 LEGER GERALD F & AMY L 25 ERIE LN GROTON CT 06340
3160 MATECUMBE KEY RD 225 PUNTA GORDA FL 33955 MARSHALL LARRY 3160 MATECUMBE KEY RD #225 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 226 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 227 PUNTA GORDA FL 33955 STEFANSKI PETER 3605 S MAYFIELD RD JACKSON WI 53037
3160 MATECUMBE KEY RD 228 PUNTA GORDA FL 33955 BADILLO LUIS & SANDRA 3160 MATECUMBE KEY RD #228 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 231 PUNTA GORDA FL 33955 HARWOOD GERALD W & HARWOOD JACQUELYN H 5198 ARROWWOOD DR PARK CITY UT 84098
3160 MATECUMBE KEY RD 232 PUNTA GORDA FL 33955 TRAVER-MUZIO SHARRON E + OBRIEN PHILLIP E L/E 24707 CEDAR RIDGE LANDINGS CIR PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 233 PUNTA GORDA FL 33955 MCDONAGH BARBARA A 5 ROCKY HOOK WALDEN MA 01880
3160 MATECUMBE KEY RD 234 PUNTA GORDA FL 33955 VECCHIARELLI ANGELO A + CARMONA BRENDA J 191 FLOWERING RIDGE RD WHITTIER NC 28789
3160 MATECUMBE KEY RD 211 PUNTA GORDA FL 33955 SANDERS KENNETH H III & SANDERS ROBERTA F + CLARK J A III ET AL 4919 GABRIEL LN WAUCHULA FL 33873
3160 MATECUMBE KEY RD 212 PUNTA GORDA FL 33955 SCOTT JOSEPH & TERRI LYNN 7996 AQUA ISLE CLAY MI 48001
3160 MATECUMBE KEY RD 213 PUNTA GORDA FL 33955 ANTHONSEN GARY 3797 PLUECKHAHN LANDINGS CIR PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 214 PUNTA GORDA FL 33955 LALONE DEREK J & NANETTE M 7779 COLONY DR CLAY MI 48001
3160 MATECUMBE KEY RD 215 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 10398 ATENIA ST PORT CHARLOTTE FL 33981
3160 MATECUMBE KEY RD 216 PUNTA GORDA FL 33955 WHELAN WILLIAM W & WHELAN BARBARA W TR TRUST 3245 SUGARLOAF KEY RD #216 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 217 PUNTA GORDA FL 33955 WEGENER JAMES W & BEVERLY S 9624 DUNES DR FORT PIERCE SD 57532
3160 MATECUMBE KEY RD 218 PUNTA GORDA FL 33955 TANNOUS BETH ANN 3160 MATECUMBE KEY RD #218 PUNTA GORDA FL 33955
3160 MATECUMBE KEY RD 221 PUNTA GORDA FL 33955 JOE S AUTOWHOLESALE INC 5708 RALEIGH DR NORFOLK VA 23502
3160 MATECUMBE KEY RD 222 PUNTA GORDA FL 33955 WTRENTAL 5 LLC 27W070 80TH ST NAPERVILLE IL 60565`;

        let unitData = {};
        let activeUnit = null;

        /**
         * Parses the raw text data into a structured JavaScript object.
         */
        function parseData() {
            const lines = RAW_DATA.trim().split('\n');
            const dataMap = {};

            lines.forEach(line => {
                const propertyAddressMatch = line.match(/(31\d{2}) MATECUMBE KEY RD\s*(\d{3}),?\s*Punta GORDA FL\s*(\d{5})/i);

                if (propertyAddressMatch) {
                    const fullPropertyAddress = propertyAddressMatch[0]; 
                    const unitId = propertyAddressMatch[2];
                    
                    const fullMatchIndex = line.indexOf(fullPropertyAddress);
                    
                    const ownerDataStart = fullMatchIndex + fullPropertyAddress.length; 
                    
                    const ownerAddressRaw = line.substring(ownerDataStart).trim();

                    let ownerName = '';
                    let mailingAddress = ownerAddressRaw;

                    const delimiters = ['—', ' L/E ', ' TR ', ' LLC ', ' INC ', ' ET AL '];
                    let delimiterIndex = -1;

                    for (const delim of delimiters) {
                        const index = ownerAddressRaw.toUpperCase().indexOf(delim);
                        if (index > -1 && (delimiterIndex === -1 || index < delimiterIndex)) {
                            delimiterIndex = index;
                        }
                    }

                    if (delimiterIndex > -1) {
                        ownerName = ownerAddressRaw.substring(0, delimiterIndex).trim();
                        
                        const delimiterUsed = delimiters.find(delim => ownerAddressRaw.toUpperCase().substring(delimiterIndex).startsWith(delim));
                        mailingAddress = ownerAddressRaw.substring(delimiterIndex + (delimiterUsed ? delimiterUsed.length : 0)).trim().replace('—', '').trim();

                    } else {
                        const firstDigitIndex = ownerAddressRaw.search(/\d/);
                        if (firstDigitIndex > 10) { 
                            ownerName = ownerAddressRaw.substring(0, firstDigitIndex).trim();
                            mailingAddress = ownerAddressRaw.substring(firstDigitIndex).trim();
                        } else {
                            ownerName = ownerAddressRaw;
                            mailingAddress = "Missing mailing address in source data, or format requires manual review.";
                        }
                    }
                    
                    ownerName = ownerName.replace(/,,/g, ',').replace(/\s+/g, ' ').trim();
                    mailingAddress = mailingAddress.replace(/,,/g, ',').replace(/\s+/g, ' ').trim();

                    dataMap[unitId] = {
                        building: propertyAddressMatch[1],
                        owner: ownerName,
                        address: mailingAddress,
                    };
                }
            });
            return dataMap;
        }

        /**
         * Renders the unit map for a given building.
         */
        function renderMap(buildingId, containerId, unitList) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous content

            unitList.forEach(unit => {
                const isDataAvailable = unitData[unit] !== undefined;
                
                const unitElement = document.createElement('div');
                let classes = 'unit';

                if (unit === 'N/A') {
                    classes += ' inactive bg-gray-100';
                    unitElement.textContent = ''; 
                } else if (!isDataAvailable) {
                    classes += ' inactive';
                    unitElement.textContent = unit;
                } else {
                    unitElement.textContent = unit;
                    unitElement.addEventListener('click', () => handleUnitClick(unitElement, unit));
                }

                unitElement.className = classes;
                unitElement.id = `unit-${unit}`;
                unitElement.dataset.unitId = unit;

                container.appendChild(unitElement);
            });
        }

        /**
         * Loads market status for a unit from localStorage.
         * @param {string} unitId 
         * @returns {{forSale: boolean, rental: boolean}}
         */
        function loadMarketStatus(unitId) {
            // Using try/catch for robust localStorage access
            try {
                const status = localStorage.getItem(`marketStatus-${unitId}`);
                return status ? JSON.parse(status) : { forSale: false, rental: false };
            } catch (error) {
                console.error("Error loading status from localStorage:", error);
                return { forSale: false, rental: false };
            }
        }

        /**
         * Saves market status for a unit to localStorage.
         * @param {string} unitId 
         * @param {{forSale: boolean, rental: boolean}} status 
         */
        function saveMarketStatus(unitId, status) {
            try {
                localStorage.setItem(`marketStatus-${unitId}`, JSON.stringify(status));
            } catch (error) {
                console.error("Could not save to localStorage:", error);
            }
        }
        
        /**
         * Applies the correct color classes to a unit element based on its market status.
         * @param {string} unitId 
         * @param {{forSale: boolean, rental: boolean}} status 
         */
        function updateUnitColor(unitId, status) {
            const unitElement = document.getElementById(`unit-${unitId}`);
            if (!unitElement || unitElement.classList.contains('inactive')) return;

            // Remove existing market classes
            unitElement.classList.remove('for-sale', 'rental');

            // Apply new classes
            if (status.forSale) {
                unitElement.classList.add('for-sale');
            }
            if (status.rental) {
                unitElement.classList.add('rental');
            }
        }
        
        /**
         * Sets up the interactive controls for market status when a unit is selected.
         * @param {string} unitId 
         */
        function setupMarketStatusControls(unitId) {
            const currentStatus = loadMarketStatus(unitId);
            const saleCheckbox = document.getElementById('for-sale-checkbox');
            const rentalCheckbox = document.getElementById('rental-checkbox');

            // 1. Set initial state of checkboxes
            saleCheckbox.checked = currentStatus.forSale;
            rentalCheckbox.checked = currentStatus.rental;
            
            // 2. Clear previous listeners (Crucial to prevent multiple listeners on the same element)
            saleCheckbox.onchange = null;
            rentalCheckbox.onchange = null;

            // 3. Attach new listeners
            const saveHandler = () => {
                const newStatus = {
                    forSale: saleCheckbox.checked,
                    rental: rentalCheckbox.checked
                };
                saveMarketStatus(unitId, newStatus);
                updateUnitColor(unitId, newStatus);
                
                // Ensure the currently selected unit retains its 'active' border/style
                const activeElement = document.getElementById(`unit-${unitId}`);
                if (activeElement && !activeElement.classList.contains('active')) {
                     activeElement.classList.add('active');
                }
            };

            saleCheckbox.onchange = saveHandler;
            rentalCheckbox.onchange = saveHandler;
        }


        /**
         * Handles the click event on a unit.
         */
        function handleUnitClick(element, unitId) {
            // Remove 'active' class from all units
            document.querySelectorAll('.unit').forEach(u => u.classList.remove('active'));
            
            // Set new active unit
            element.classList.add('active');
            activeUnit = element;

            // Update info panel
            updateInfoPanel(unitId);
            
            // Setup market status controls for the newly selected unit
            setupMarketStatusControls(unitId);
        }

        /**
         * Updates the information panel with data for the selected unit.
         */
        function updateInfoPanel(unitId) {
            const data = unitData[unitId];
            
            // Safety check for data availability before accessing properties
            if (!data) {
                document.getElementById('info-title').textContent = `Unit ${unitId} Details (Data Missing)`;
                document.getElementById('owner-name').textContent = 'N/A (Data could not be parsed)';
                document.getElementById('mailing-address').textContent = 'N/A (Data could not be parsed)';
                
                // Hide or disable market controls if data is missing
                document.getElementById('market-status-section').style.display = 'none';
                return;
            }
            
            // Show market controls if data is available
            document.getElementById('market-status-section').style.display = 'flex';

            document.getElementById('info-title').textContent = `Unit ${unitId} Details`;
            document.getElementById('owner-name').textContent = data.owner || 'N/A';
            document.getElementById('mailing-address').textContent = data.address || 'N/A';
        }


        // --- Initialization ---
        window.onload = function() {
            unitData = parseData();

            // Unit lists are manually ordered for a clean, 4x6 grid layout (24 slots each).
            const map_3170 = [
                '111', '112', '113', '114',
                '115', '116', '117', '118',
                '121', '122', '123', '124',
                '125', '126', 
                '127', '128',
                '131', '132', '133', '134',
                '135', 'N/A', '137', '138' 
            ];
            renderMap('3170', 'grid-3170', map_3170);
            
            const map_3160 = [
                '211', '212', '213', '214', 
                '215', '216', '217', '218',
                '221', '222', '223', '224',
                '225', '226', '227', '228',
                '231', '232', '233', '234',
                '235', '236', '237', '238'
            ];
            renderMap('3160', 'grid-3160', map_3160);
            
            // Apply colors from localStorage after rendering
            [...map_3170, ...map_3160].filter(id => id !== 'N/A').forEach(unitId => {
                const status = loadMarketStatus(unitId);
                updateUnitColor(unitId, status);
            });

            // Automatically select the first unit of BUILDING 2 (Unit 211)
            const firstUnitId_3160 = map_3160.find(id => id !== 'N/A');
            if (firstUnitId_3160) {
                const firstUnitElement = document.getElementById(`unit-${firstUnitId_3160}`);
                if (firstUnitElement) {
                    handleUnitClick(firstUnitElement, firstUnitId_3160);
                }
            }
        };
    </script>
</body>
</html>

